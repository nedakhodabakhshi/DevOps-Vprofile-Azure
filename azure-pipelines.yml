trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: vProfile-Secrets  # دریافت متغیرها از Azure DevOps Library

stages:
- stage: Build
  displayName: 'Build and Push Docker Image'
  jobs:
  - job: Build
    steps:
    - task: Docker@2
      displayName: 'Build Docker Image'
      inputs:
        command: 'build'
        Dockerfile: '**/Dockerfile'
        repository: '$(ACR_LOGIN_SERVER)/$(IMAGE_NAME)'
        tags: 'latest'
    
    - script: |
        echo $(ACR_PASSWORD) | docker login $(ACR_LOGIN_SERVER) -u $(ACR_USERNAME) --password-stdin
      displayName: 'Login to ACR'
    
    - task: Docker@2
      displayName: 'Push Docker Image to ACR'
      inputs:
        command: 'push'
        repository: '$(ACR_LOGIN_SERVER)/$(IMAGE_NAME)'
        tags: 'latest'

- stage: Deploy
  displayName: 'Deploy to AKS'
  dependsOn: Build
  jobs:
  - job: Deploy
    steps:
    - script: |
        az aks get-credentials --resource-group $(RESOURCE_GROUP) --name $(AKS_CLUSTER)
      displayName: 'Configure kubectl'
    
    - task: Kubernetes@1
      displayName: 'Deploy to AKS'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscription: 'Your-Azure-Service-Connection'
        azureResourceGroup: $(RESOURCE_GROUP)
        kubernetesCluster: $(AKS_CLUSTER)
        namespace: 'default'
        command: 'apply'
        arguments: '-f deployment.yaml -f service.yaml'
